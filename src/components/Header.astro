---
import HeaderLink from './HeaderLink.astro';
import { SITE_TITLE } from '../consts';

// Normalize base URL
const rawBase = import.meta.env.BASE_URL || '/';
const base = rawBase.endsWith('/') ? rawBase : `${rawBase}/`;
const link = (p: string = '') => `${base}${p}`;
---

<header>
  <nav>
    <h2><a href={base}>{SITE_TITLE}</a></h2>

    <!-- Mobile toggle (hidden on desktop) -->
    <button
      class="menu-toggle"
      type="button"
      aria-label="Toggle navigation"
      aria-expanded="false"
      aria-controls="primary-nav"
    >☰</button>

    <!-- Wrap links + contact so desktop stays inline, mobile becomes a panel -->
    <div id="primary-nav" class="menu-panel">
      <div class="internal-links">
        <HeaderLink href={link('')}>Home</HeaderLink>
        <HeaderLink href={link('blog/')}>Blog</HeaderLink>
        <HeaderLink href={link('templates/')}>Templates</HeaderLink>
        <HeaderLink href={link('books/')}>Books</HeaderLink>
        <HeaderLink href={link('albums/')}>Albums</HeaderLink>
        <HeaderLink href={link('art/')}>Art</HeaderLink>
        <HeaderLink href={link('inspirations/')}>Inspirations</HeaderLink>
        <HeaderLink href={link('guitar/')}>Guitar</HeaderLink>
        <HeaderLink href={link('projects/')}>Projects</HeaderLink>
        <HeaderLink href={link('about/')}>About</HeaderLink>
      </div>

      <div class="contact-button">
        <a href="mailto:smartstuffstays@gmail.com">Contact</a>
      </div>
    </div>
  </nav>
</header>

<style>
  header {
    margin: 0;
    padding: 0 1em;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .5rem;
  }

  h2 { margin: 0; font-size: 1em; }
  h2 a, h2 a.active { text-decoration: none; color: var(--black, #0e121b); font-weight: 600; }

  /* Desktop: keep original inline layout */
  .menu-panel {
    display: flex;
    align-items: center;
    gap: .25rem;
  }
  .internal-links {
    display: flex;
    flex-wrap: nowrap;
    gap: .25rem;
  }
  .internal-links :global(a) {
    padding: 1em .5em;
    color: var(--black, #0e121b);
    border-bottom: 4px solid transparent;
    text-decoration: none;
  }
  .internal-links :global(a.active) { border-bottom-color: var(--accent, #405cf5); }

  /* Contact button matches your original intent */
  .contact-button a {
    background: transparent;
    color: #2563eb;
    border: 2px solid #2563eb;
    padding: .5rem 1.1rem;
    border-radius: 9999px;
    font-weight: 600;
    transition: all .25s ease;
    text-decoration: none;
    white-space: nowrap;
  }
  .contact-button a:hover { background: #2563eb; color: #fff; }

  /* Hidden by default on desktop */
  .menu-toggle {
    display: none;
    border: 1px solid rgba(0,0,0,.12);
    background: #fff;
    border-radius: .6rem;
    padding: .45rem .65rem;
    font-size: 1.15rem;
    line-height: 1;
  }

  /* ===== Mobile only (≤900px) ===== */
  @media (max-width: 900px) {
    .menu-toggle { display: inline-block; z-index: 60; }

    /* Turn the group into a dropdown panel */
    .menu-panel {
      position: absolute;
      left: 0; right: 0; top: 100%;
      background: #fff;
      border-top: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
      display: none;                /* hidden until toggled */
      flex-direction: column;
      align-items: stretch;
      padding: .25rem 0;
    }
    .menu-panel.open { display: flex; }

    .internal-links {
      display: grid;
      grid-template-columns: 1fr 1fr; /* compact grid */
      gap: 0;
    }
    .internal-links :global(a) {
      padding: .85rem 1rem;
      border-bottom: 1px solid rgba(0,0,0,.04);
    }

    .contact-button { padding: .35rem 1rem .6rem; }
    .contact-button a { display: block; text-align: center; }

    /* Slightly smaller brand spacing on mobile */
    h2 a { padding: .2rem 0; }
  }

  /* Very small phones → single column list */
  @media (max-width: 420px) {
    .internal-links { grid-template-columns: 1fr; }
  }
</style>

<script>
  // Bind after DOM ready and on Astro client navigations
  const init = () => {
    const btn = document.querySelector('.menu-toggle');
    const panel = document.getElementById('primary-nav');
    if (!btn || !panel) return;

    if (!btn.__bound) {
      btn.__bound = true;
      btn.addEventListener('click', () => {
        const open = panel.classList.toggle('open');
        btn.setAttribute('aria-expanded', String(open));
      });
    }

    // Close panel when any link is tapped
    if (!panel.__bound) {
      panel.__bound = true;
      panel.addEventListener('click', (e) => {
        const t = e.target;
        if (t && t.tagName === 'A') {
          panel.classList.remove('open');
          btn.setAttribute('aria-expanded', 'false');
        }
      });
    }
  };

  document.addEventListener('DOMContentLoaded', init);
  document.addEventListener('astro:page-load', init);
</script>
