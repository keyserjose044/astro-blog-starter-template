---
const API_URL =
  'https://script.google.com/macros/s/AKfycbwwwRh_cplVt-ZprMrs7oxbFI9UEf--yNNF1PAdNq2NmGXO2luEkmqNiuMIhzN2gMbq/exec';

// For now we only wire Guitar Hours; other metrics can be added later.
const metricLabel = 'Guitar Hours';
const metricKey = 'guitar';
---

<section class="section" aria-labelledby="graphs-heading">
  <h2 id="graphs-heading">ðŸ“ˆ Detailed Stat Graphs</h2>
  <p class="section-hint">
    Explore how key stats evolve over time. Start with monthly Guitar Hours, powered by your Archive sheet.
  </p>

  <div class="graph-card">
    <div class="graph-card__header">
      <div class="graph-card__title">
        ðŸŽ¸ {metricLabel} by Month
      </div>

      <div class="graph-card__controls">
        <label class="graph-card__control">
          <span>Year</span>
          <select id="guitar-year-select"></select>
        </label>
      </div>
    </div>

    <div class="graph-card__body">
      <div id="guitar-chart" class="graph-card__chart">
        <div class="graph-card__fallback">
          Loading chartâ€¦
        </div>
      </div>
    </div>
  </div>

  <!-- D3 from CDN -->
  <script
    src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"
    defer
  ></script>

  <!-- Client-side script to fetch data + draw chart -->
  <script type="module">
    const API_URL = `${API_URL}`;
    const metricKey = `${metricKey}`;
    const monthOrder = [
      'Jan',
      'Feb',
      'Mar',
      'Apr',
      'May',
      'Jun',
      'Jul',
      'Aug',
      'Sep',
      'Oct',
      'Nov',
      'Dec'
    ];

    function ready(fn) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else {
        fn();
      }
    }

    ready(async () => {
      const container = document.getElementById('guitar-chart');
      const select = document.getElementById('guitar-year-select');

      if (!container || !select) return;

      // Wait until D3 is available from CDN
      const waitForD3 = () =>
        new Promise((resolve) => {
          const check = () => {
            if (window.d3) resolve(window.d3);
            else requestAnimationFrame(check);
          };
          check();
        });

      const d3 = await waitForD3();

      let rawData;
      try {
        const res = await fetch(API_URL);
        rawData = await res.json();
      } catch (err) {
        container.innerHTML =
          '<div class="graph-card__fallback">Error loading data from GAS.</div>';
        console.error('Fetch error:', err);
        return;
      }

      // Expect objects like { metric, year, month, value }
      const data = rawData
        .filter((d) => d.metric === metricKey)
        .map((d) => ({
          metric: d.metric,
          year: +d.year,
          month: d.month,
          value: +d.value
        }));

      if (!data.length) {
        container.innerHTML =
          '<div class="graph-card__fallback">No data received for guitar.</div>';
        return;
      }

      const years = Array.from(new Set(data.map((d) => d.year))).sort(
        (a, b) => a - b
      );

      // Populate year dropdown (latest year selected by default)
      select.innerHTML = years
        .map(
          (y, idx) =>
            `<option value="${y}" ${
              idx === years.length - 1 ? 'selected' : ''
            }>${y}</option>`
        )
        .join('');

      select.addEventListener('change', () =>
        drawChart(+select.value, data, container, d3)
      );

      // Initial render
      const initialYear = years[years.length - 1];
      drawChart(initialYear, data, container, d3);

      // Make chart responsive on resize
      window.addEventListener('resize', () =>
        drawChart(+select.value, data, container, d3)
      );
    });

    function drawChart(year, data, container, d3) {
      const yearData = monthOrder.map((m) => {
        const match = data.find(
          (d) => d.year === year && d.month === m
        );
        return {
          month: m,
          value: match ? match.value : 0
        };
      });

      const margin = { top: 24, right: 24, bottom: 40, left: 48 };
      const width = container.clientWidth || 800;
      const height = 360;

      // Clear previous SVG
      container.innerHTML = '';

      const svg = d3
        .select(container)
        .append('svg')
        .attr('viewBox', `0 0 ${width} ${height}`)
        .attr('preserveAspectRatio', 'xMidYMid meet');

      const x = d3
        .scalePoint()
        .domain(monthOrder)
        .range([margin.left, width - margin.right])
        .padding(0.5);

      const y = d3
        .scaleLinear()
        .domain([0, d3.max(yearData, (d) => d.value) || 1])
        .nice()
        .range([height - margin.bottom, margin.top]);

      const area = d3
        .area()
        .x((d) => x(d.month))
        .y0(height - margin.bottom)
        .y1((d) => y(d.value))
        .curve(d3.curveMonotoneX);

      const line = d3
        .line()
        .x((d) => x(d.month))
        .y((d) => y(d.value))
        .curve(d3.curveMonotoneX);

      // Axes
      const xAxis = d3.axisBottom(x);
      const yAxis = d3.axisLeft(y).ticks(6).tickFormat(d3.format('~s'));

      svg
        .append('g')
        .attr(
          'transform',
          `translate(0, ${height - margin.bottom})`
        )
        .call(xAxis)
        .selectAll('text')
        .style('font-size', '10px');

      svg
        .append('g')
        .attr('transform', `translate(${margin.left},0)`)
        .call(yAxis)
        .selectAll('text')
        .style('font-size', '10px');

      // Area
      svg
        .append('path')
        .datum(yearData)
        .attr('fill', '#1d4ed81a') // translucent blue
        .attr('d', area);

      // Line
      svg
        .append('path')
        .datum(yearData)
        .attr('fill', 'none')
        .attr('stroke', '#2563eb')
        .attr('stroke-width', 2)
        .attr('d', line);

      // Points + labels
      svg
        .selectAll('.point')
        .data(yearData)
        .enter()
        .append('circle')
        .attr('class', 'point')
        .attr('cx', (d) => x(d.month))
        .attr('cy', (d) => y(d.value))
        .attr('r', 3)
        .attr('fill', '#2563eb');

      svg
        .selectAll('.label')
        .data(yearData)
        .enter()
        .append('text')
        .attr('class', 'label')
        .attr('x', (d) => x(d.month))
        .attr('y', (d) => y(d.value) - 8)
        .attr('text-anchor', 'middle')
        .style('font-size', '10px')
        .style('fill', '#64748b')
        .text((d) => (d.value ? d.value : ''));
    }
  </script>

  <style>
    .graph-card {
      margin-top: 3rem;
      padding: 1.5rem;
      border-radius: 1rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
    }

    .graph-card__header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .graph-card__title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .graph-card__controls {
      margin-left: auto;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .graph-card__control {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .graph-card__control select {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.875rem;
    }

    .graph-card__body {
      margin-top: 0.5rem;
    }

    .graph-card__chart {
      width: 100%;
      min-height: 260px;
    }

    .graph-card__fallback {
      padding: 2rem 1rem;
      text-align: center;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .graph-card {
        padding: 1.25rem;
      }

      .graph-card__controls {
        margin-left: 0;
      }
    }
  </style>
</section>
