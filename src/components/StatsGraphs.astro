---
// For now we only wire Guitar Hours; other metrics can be added later.
const metricLabel = 'Guitar Hours';
---

<section class="section" aria-labelledby="graphs-heading">
  <h2 id="graphs-heading">ðŸ“ˆ Detailed Stat Graphs</h2>
  <p class="section-hint">
    Explore how key stats evolve over time. Start with monthly Guitar Hours, powered by your Archive sheet.
  </p>

  <div class="graph-card">
    <div class="graph-card__header">
      <div class="graph-card__title">
        ðŸŽ¸ {metricLabel} by Month
      </div>

      <div class="graph-card__controls">
        <label class="graph-card__control">
          <span>Year</span>
          <select id="guitar-year-select"></select>
        </label>
      </div>
    </div>

    <div class="graph-card__body">
      <div id="guitar-chart" class="graph-card__chart">
        <div class="graph-card__fallback">
          Loading chartâ€¦
        </div>
      </div>
    </div>
  </div>

  <!-- D3 from CDN -->
  <script
    src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"
    defer
  ></script>

  <!-- Client-side script to fetch data + draw chart -->
  <script>
    (function () {
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwwwRh_cplVt-ZprMrs7oxbFI9UEf--yNNF1PAdNq2NmGXO2luEkmqNiuMIhzN2gMbq/exec";
      const metricKey = "guitar";
      const monthOrder = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ];

      function whenReady(fn) {
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", fn);
        } else {
          fn();
        }
      }

      whenReady(() => {
        // wait for D3 + DOM
        function start() {
          const d3 = window.d3;
          const container = document.getElementById("guitar-chart");
          const select = document.getElementById("guitar-year-select");

          if (!d3 || !container || !select) {
            // try again shortly until everything exists
            return setTimeout(start, 50);
          }

          initChart(d3, container, select);
        }

        start();
      });

      async function initChart(d3, container, select) {
        let rawData;

        try {
          const res = await fetch(API_URL);
          rawData = await res.json();
        } catch (err) {
          console.error("Error fetching graph data:", err);
          container.innerHTML =
            '<div class="graph-card__fallback">Error loading data from GAS.</div>';
          return;
        }

        // Ensure we have an array
        if (!Array.isArray(rawData)) {
          rawData = Object.values(rawData || {});
        }

        // Expect objects like { metric: "guitar", year: 2024, month: "Jan", value: 4 }
        const data = rawData
          .filter((d) => !metricKey || String(d.metric).toLowerCase() === metricKey)
          .map((d) => ({
            metric: d.metric,
            year: Number(d.year),
            month: String(d.month),
            value: Number(d.value) || 0,
          }));

        if (!data.length) {
          console.warn("No data points found for guitar:", rawData);
          container.innerHTML =
            '<div class="graph-card__fallback">No guitar data found.</div>';
          return;
        }

        const years = Array.from(new Set(data.map((d) => d.year))).sort(
          (a, b) => a - b
        );

        // Populate year dropdown (latest year selected by default)
        select.innerHTML = years
          .map(
            (y, idx) =>
              `<option value="${y}" ${
                idx === years.length - 1 ? "selected" : ""
              }>${y}</option>`
          )
          .join("");

        select.addEventListener("change", () =>
          drawChart(Number(select.value), data, container, d3)
        );

        const initialYear = years[years.length - 1];
        drawChart(initialYear, data, container, d3);

        window.addEventListener("resize", () =>
          drawChart(Number(select.value), data, container, d3)
        );
      }

      function drawChart(year, data, container, d3) {
        const yearData = monthOrder.map((m) => {
          const match = data.find((d) => d.year === year && d.month === m);
          const raw = match ? match.value : 0;
          const value = Math.round(raw);  // ðŸ‘ˆ round here (or Math.round(raw * 10)/10 for 1 decimal)
          return { month: m, value };
        });

        const margin = { top: 24, right: 24, bottom: 40, left: 48 };
        const width = container.clientWidth || 800;
        const height = 360;

        container.innerHTML = "";

        const svg = d3
          .select(container)
          .append("svg")
          .attr("viewBox", `0 0 ${width} ${height}`)
          .attr("preserveAspectRatio", "xMidYMid meet");

        const x = d3
          .scalePoint()
          .domain(monthOrder)
          .range([margin.left, width - margin.right])
          .padding(0.5);

        const y = d3
          .scaleLinear()
          .domain([0, d3.max(yearData, (d) => d.value) || 1])
          .nice()
          .range([height - margin.bottom, margin.top]);

        const area = d3
          .area()
          .x((d) => x(d.month))
          .y0(height - margin.bottom)
          .y1((d) => y(d.value))
          .curve(d3.curveMonotoneX);

        const line = d3
          .line()
          .x((d) => x(d.month))
          .y((d) => y(d.value))
          .curve(d3.curveMonotoneX);

        // Axes
        svg
          .append("g")
          .attr("transform", `translate(0, ${height - margin.bottom})`)
          .call(d3.axisBottom(x))
          .selectAll("text")
          .style("font-size", "10px");

        svg
          .append("g")
          .attr("transform", `translate(${margin.left},0)`)
          .call(d3.axisLeft(y).ticks(6).tickFormat(d3.format("~s")))
          .selectAll("text")
          .style("font-size", "10px");

        // Area fill
        svg
          .append("path")
          .datum(yearData)
          .attr("fill", "#1d4ed81a")
          .attr("d", area);

        // Line
        svg
          .append("path")
          .datum(yearData)
          .attr("fill", "none")
          .attr("stroke", "#2563eb")
          .attr("stroke-width", 2)
          .attr("d", line);

        // Points
        svg
          .selectAll(".point")
          .data(yearData)
          .enter()
          .append("circle")
          .attr("class", "point")
          .attr("cx", (d) => x(d.month))
          .attr("cy", (d) => y(d.value))
          .attr("r", 3)
          .attr("fill", "#2563eb");

        // Labels
        svg
          .selectAll(".label")
          .data(yearData)
          .enter()
          .append("text")
          .attr("class", "label")
          .attr("x", (d) => x(d.month))
          .attr("y", (d) => y(d.value) - 8)
          .attr("text-anchor", "middle")
          .style("font-size", "10px")
          .style("fill", "#9ca3af")
          .text((d) => (d.value ? d3.format("d")(d.value) : ""));
      }
    })();
  </script>


  <style>
    .graph-card {
      margin-top: 3rem;
      padding: 1.5rem;
      border-radius: 1rem;
      background: #ffffff;                 /* white card */
      border: 1px solid #e5e7eb;           /* light gray border */
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12); /* softer shadow */
    }

    .graph-card__header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      color: #111827;                      /* dark title text */
    }

    .graph-card__title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .graph-card__controls {
      margin-left: auto;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .graph-card__control {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .graph-card__control select {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #f9fafb;                /* light pill background */
      color: #e5e7eb;
      font-size: 0.875rem;
    }

    .graph-card__body {
      margin-top: 0.5rem;
    }

    .graph-card__chart {
      width: 100%;
      min-height: 260px;
    }

    .graph-card__fallback {
      padding: 2rem 1rem;
      text-align: center;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .graph-card {
        padding: 1.25rem;
      }

      .graph-card__controls {
        margin-left: 0;
      }
    }
  </style>
</section>
