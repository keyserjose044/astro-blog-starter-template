---
/**
 * Full-page background video wrapper for LifeLoggerz.
 * Uses the global .page-with-video-bg styles.
 */

const base = import.meta.env.BASE_URL || '/';
const backgroundVideoSrc = `${base}backgrounds/waves.mp4?v=2`;
---

<div class="page-with-video-bg">
  <video
    src={backgroundVideoSrc}
    autoplay
    muted
    loop
    playsinline
    preload="auto"
    class="page-with-video-bg__video"
  ></video>

  <div class="page-with-video-bg__content">
    <slot />
  </div>
</div>

<script is:inline>
  if (typeof window !== 'undefined') {
    const getVideo = () =>
      document.querySelector('.page-with-video-bg__video');

    const ensurePlaying = () => {
      const video = getVideo();
      if (!video) return;

      // If browser has enough data and it's paused, try to play
      if (video.readyState >= 2 && video.paused) {
        video.play().catch(() => {
          // Ignore autoplay failures (mobile, user gesture rules, etc.)
        });
      }
    };

    let guardianId = null;

    const startGuardian = () => {
      if (guardianId !== null) return;
      // Check twice a second while visible
      guardianId = window.setInterval(() => {
        if (document.visibilityState !== 'visible') return;
        ensurePlaying();
      }, 500);
    };

    const stopGuardian = () => {
      if (guardianId !== null) {
        clearInterval(guardianId);
        guardianId = null;
      }
    };

    // Kick it immediately on script run
    ensurePlaying();
    startGuardian();

    // When coming back via Back / bfcache
    window.addEventListener('pageshow', () => {
      ensurePlaying();
      startGuardian();
    });

    // When tab becomes visible again
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        ensurePlaying();
        startGuardian();
      } else {
        // optional: stopGuardian();  // you can leave it running too
      }
    });

    // Clean up on unload
    window.addEventListener('beforeunload', () => {
      stopGuardian();
    });

    // (Optional) Also respond to focus events, just in case
    window.addEventListener('focus', () => {
      ensurePlaying();
      startGuardian();
    });
  }
</script>
