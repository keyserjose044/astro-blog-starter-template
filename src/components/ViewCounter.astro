---
/**
 * ViewCounter.astro
 * Props:
 *   path?: string   // per-page key; pass Astro.url.pathname for unique counts
 *   label?: string  // default "views"
 */
const { path = "", label = "views" } = Astro.props;

// unique id so multiple counters on one page won't clash
const elId = "llz-view-" + Math.random().toString(36).slice(2, 8);
---
<span id={elId} aria-live="polite">â€”</span>

<script is:inline>
  (() => {
    const normalize = (p) => {
      try {
        return new URL("https://x" + (p.startsWith("/") ? p : "/" + p))
          .pathname.replace(/\/+$/,"") || "/";
      } catch { return "/"; }
    };

    const elId = ${JSON.stringify(elId)};
    const serverPath = ${JSON.stringify(path)};
    const label = ${JSON.stringify(label)};

    // prefer server-provided path; fall back to current location
    const p = normalize(serverPath || location.pathname);

    // 1) increment (fire-and-forget) on same origin
    try {
      fetch(`/v?p=${encodeURIComponent(p)}`, {
        mode: "no-cors",
        keepalive: true
      });
    } catch (_) {}

    // 2) read & render from same origin
    fetch(`/count/views?p=${encodeURIComponent(p)}`, { cache: "no-store" })
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(({ count }) => {
        const el = document.getElementById(elId);
        if (el) el.textContent = `${count} ${label}`;
      })
      .catch((e) => {
        // helpful while wiring up; remove later if you want
        console.warn("ViewCounter read failed:", e);
      });
  })();
</script>
