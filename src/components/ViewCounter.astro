---
/**
 * ViewCounter.astro
 * Props:
 *   path?: string   // per-page key, e.g. "/blog/my-post"
 *   label?: string  // default "views"
 */
const { path = "", label = "views" } = Astro.props;
---

<span id="llz-view-count" aria-live="polite">â€”</span>

<script is:inline>
  (() => {
    const normalize = (p) => {
      try {
        return new URL("https://x" + (p.startsWith("/") ? p : "/" + p))
          .pathname.replace(/\/+$/,"") || "/";
      } catch { return "/"; }
    };

    // Prefer the server-injected path so every page has a unique key
    const serverPath = ${JSON.stringify(path)};
    const label = ${JSON.stringify(label)};
    const p = normalize(serverPath || location.pathname);

    // increment
    fetch(`https://stats.lifeloggerz.com/v?p=${encodeURIComponent(p)}`, {
      mode: "no-cors",
      keepalive: true
    });

    // read + render
    fetch(`https://stats.lifeloggerz.com/count/views?p=${encodeURIComponent(p)}`, {
      cache: "no-store"
    })
      .then(r => r.json())
      .then(({ count }) => {
        const el = document.getElementById("llz-view-count");
        if (el) el.textContent = `${count} ${label}`;
      })
      .catch(() => {});
  })();
</script>
