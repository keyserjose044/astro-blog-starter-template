---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import VideoBg from '../components/VideoBg.astro';
import { SITE_TITLE } from '../consts';

// Hardcoded per your current page
const RAINDROP_TOKEN = "2df3b611-fa2c-4794-a359-1bf08efdd67f";
const COLLECTION_ID  = "59630582";

async function fetchAllRaindrops() {
  const perPage = 50;
  let page = 0, items: any[] = [];
  while (true) {
    const res = await fetch(
      `https://api.raindrop.io/rest/v1/raindrops/${COLLECTION_ID}?perpage=${perPage}&page=${page}`,
      { headers: { Authorization: `Bearer ${RAINDROP_TOKEN}` } }
    );
    if (!res.ok) throw new Error(`Raindrop fetch failed (${res.status}): ${await res.text()}`);
    const batch = (await res.json())?.items ?? [];
    if (!batch.length) break;
    items.push(...batch);
    if (batch.length < perPage) break;
    page++;
  }
  items.sort(
    (a,b)=> new Date(b.created||b.lastUpdate||0).getTime()
           - new Date(a.created||a.lastUpdate||0).getTime()
  );
  const placeholder = '/images_webp/album-placeholder.webp';
  return items.map((it)=>({
    id: it._id,
    title: it.title ?? 'Untitled',
    href: it.link ?? '#',
    cover: it.cover || it.media?.[0]?.link || placeholder,
    note: (typeof it.note==='string'?it.note:'') || (typeof it.excerpt==='string'?it.excerpt:''),
    tags: it.tags ?? []
  }));
}
const guitar = await fetchAllRaindrops();
---

<!doctype html>
<html lang="en">
<head>
  <BaseHead
    title={`${SITE_TITLE} â€” Guitar`}
    description="Guitar links powered by Raindrop â€” auto-updated from my collection."
  />

  <style>
    :root{--gap:22px;--ink:#0e121b;--muted:#5e6573;--border:#e6e9ef;--surface:#fff}
    *{box-sizing:border-box}

    /* HERO VIDEO */
    .hero-video {
      position: relative;
      width: 100%;
      height: 55vh;
      overflow: hidden;
      margin-bottom: 32px;
    }
    .hero-video video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: brightness(0.85);
    }
    .hero-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
      text-shadow: 0 2px 16px rgba(0,0,0,0.6);
      padding-inline: 20px;
    }
    .hero-overlay h1 {
      font-size: clamp(2rem, 4vw, 4rem);
      margin: 0 0 0.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .hero-overlay p {
      font-size: clamp(1rem, 1.7vw, 1.4rem);
      margin: 0;
      opacity: 0.9;
    }

    /* HERO VIDEO AUDIO TOGGLE */
    .hero-audio-toggle {
      position: absolute;
      right: 18px;
      bottom: 18px;
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.6);
      background: rgba(0,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #fff;
      font-size: 1.2rem;
      z-index: 5;
      box-shadow: 0 6px 18px rgba(0,0,0,0.4);
      backdrop-filter: blur(6px);
      transition: transform 0.12s ease, background 0.12s ease, box-shadow 0.12s ease;
    }
    .hero-audio-toggle:hover {
      transform: translateY(-1px);
      background: rgba(0,0,0,0.75);
      box-shadow: 0 10px 24px rgba(0,0,0,0.6);
    }
    .hero-audio-toggle span {
      pointer-events: none;
    }

    .wrap{margin:0 auto;padding-block:28px 48px;padding-inline:clamp(16px,3vw,48px);max-width:100%}
    .wrap--wide{width:100dvw;margin-left:calc(50% - 50dvw);margin-right:calc(50% - 50dvw);padding-inline:0}

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin:6px auto 32px;
      padding-inline:clamp(16px,3vw,48px);
      max-width:960px;
      width:100%;
    }
    .toolbar input[type="search"]{
      width:100%;
      max-width:none;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--ink);
      font-size:.95rem;
      box-shadow:0 1px 2px rgba(0,0,0,.03);
      flex:1;
    }
    .toolbar-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill-icon{
      width:40px;
      height:40px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f0f2f7;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
      cursor:pointer;
      text-decoration:none;
      color:var(--ink);
      box-shadow:0 1px 3px rgba(15,23,42,0.08);
      transition:background 0.12s ease, box-shadow 0.12s ease, transform 0.12s ease;
    }
    .pill-icon:hover{
      background:#e3e7f0;
      box-shadow:0 4px 10px rgba(15,23,42,0.16);
      transform:translateY(-1px);
    }

    .grid{display:grid;gap:var(--gap);align-items:start;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));max-width:100%}

    @media (min-width:1800px){
      .grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
    }

    .fullbleed{width:100%;margin:0;padding-inline:clamp(16px,3vw,48px)}

    .card{position:relative;display:flex;flex-direction:column;gap:8px;text-decoration:none;color:inherit;border-radius:12px}
    .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);background:#f0f2f7;border:1px solid var(--border)}

    .title{font-weight:700;font-size:.98rem;line-height:1.3}

    .note-bubble{position:absolute;left:50%;top:-10px;transform:translate(calc(-50% + var(--shift,0px)),-100%);width:max-content;max-width:min(600px,90vw);white-space:normal;background:rgba(20,23,31,.96);color:#fff;font-size:.9rem;line-height:1.35;padding:10px 12px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:10;pointer-events:none;opacity:0;visibility:hidden;transition:opacity .15s ease,visibility .15s ease;text-align:left;text-wrap:pretty;hyphens:auto;word-break:break-word}
    .note-bubble::after{content:"";position:absolute;left:50%;top:100%;transform:translateX(-50%);border:8px solid transparent;border-top-color:rgba(20,23,31,.96)}

    .card:hover .note-bubble,
    .card:focus-within .note-bubble,
    .card.show-note .note-bubble{opacity:1;visibility:visible}

    @media (max-width:700px){
      .note-bubble{top:auto;bottom:-10px;transform:translate(calc(-50% + var(--shift,0px)),100%)}
      .note-bubble::after{top:auto;bottom:100%;border-top-color:transparent;border-bottom-color:rgba(20,23,31,.96)}
    }

    .empty{text-align:center;color:var(--muted);padding:40px 0 24px}

    /* INFO MODAL */
    .info-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.52);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
    }
    .info-modal-backdrop.is-open{
      display:flex;
    }
    .info-modal{
      background:#ffffff;
      color:var(--ink);
      max-width:680px;
      width:calc(100% - 32px);
      border-radius:18px;
      padding:20px 22px 18px;
      box-shadow:0 22px 60px rgba(15,23,42,0.5);
      max-height:80vh;
      overflow:auto;
      font-size:.95rem;
      line-height:1.55;
    }
    .info-modal h2{
      margin:0 0 6px;
      font-size:1.1rem;
    }
    .info-modal p{
      margin:0 0 10px;
      color:var(--ink);
    }
    .info-modal small{
      color:var(--muted);
    }
    .info-modal ul{
      margin:0 0 10px 18px;
      padding:0;
    }
    .info-modal-close-row{
      display:flex;
      justify-content:flex-end;
      margin-top:4px;
    }
    .info-modal-close{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:.9rem;
      cursor:pointer;
      padding:4px 8px;
    }
    .info-modal-close:hover{
      color:var(--ink);
    }
  </style>
</head>

<body>
  <VideoBg>
    <Header />

    <!-- HERO VIDEO SECTION -->
    <div class="hero-video">
      <video
        autoplay
        muted
        loop
        playsinline
        preload="auto"
      >
        <source src="/videos/guitar.mp4" type="video/mp4" />
      </video>

      <div class="hero-overlay">
        <h1>ðŸŽ¸ Guitar</h1>
        <p>Licks, lessons, gear & inspiration â€” collected over time.</p>
      </div>

      <!-- MUTE / UNMUTE BUTTON -->
      <button
        class="hero-audio-toggle"
        type="button"
        aria-label="Unmute video"
        data-muted="true"
      >
        <span>ðŸ”‡</span>
      </button>
    </div>

    <main class="wrap wrap--wide">
      <div class="toolbar">
        <input id="q" type="search" placeholder="Search title or noteâ€¦" aria-label="Filter guitar items" />
        <div class="toolbar-actions">
          <button
            class="pill-icon"
            type="button"
            id="guitar-help-btn"
            aria-label="How I practice & track guitar"
          >?</button>
          <a
            class="pill-icon"
            href="/stats#guitar"
            aria-label="View guitar stats & graphs"
          >ðŸ“Š</a>
        </div>
      </div>

      {guitar.length === 0 ? (
        <div class="empty">No guitar items found in this collection.</div>
      ) : (
        <div class="grid fullbleed" id="grid" role="list">
          {guitar.map(g => (
            <a
              class="card"
              role="listitem"
              href={g.href}
              target="_blank"
              rel="noopener noreferrer"
              title={g.title}
              data-title={g.title.toLowerCase()}
              data-note={(g.note || '').toLowerCase()}
            >
              <img
                class="thumb"
                src={g.cover}
                alt={g.title}
                loading="lazy"
                decoding="async"
                sizes="(min-width: 1800px) 300px, (min-width: 900px) 25vw, 50vw"
              />
              <div class="title">{g.title}</div>
              {g.note ? <div class="note-bubble" role="tooltip">{g.note}</div> : null}
            </a>
          ))}
        </div>
      )}
    </main>

    <!-- INFO MODAL FOR PRACTICE SYSTEM -->
    <div class="info-modal-backdrop" id="guitar-help-modal" aria-hidden="true">
      <div class="info-modal" role="dialog" aria-modal="true" aria-labelledby="guitar-help-title">
        <h2 id="guitar-help-title">How I Practice & Track Guitar</h2>
        <p>
          Guitar, for me, isnâ€™t just a hobby â€” itâ€™s a long-term experiment in deliberate
          practice. I follow a simple rule: <strong>10 minutes a day, no exceptions</strong>.
          The goal is to install the habit first; depth and progress come after consistency.
          When motivation is high, I go longer. When Iâ€™m tired or burned out, I fall back
          to the <strong>maintenance floor</strong> â€” but I never stop.
        </p>

        <ul>
          <li><strong>Two streams:</strong> Technique/Acquisition and Song/Composition.</li>
          <li><strong>Date-based logging:</strong> every learning event is anchored in time.</li>
          <li><strong>Boredom as signal:</strong> when repeats get stale, I expand technique instead of quitting.</li>
          <li><strong>Burnout-tolerant:</strong> load drops, but the habit stays alive.</li>
          <li><strong>Tracked in Google Sheets:</strong> techniques, songs, reps, and notes across years.</li>
          <li><strong>Cycle:</strong> fundamentals â†’ novelty â†’ refinement â†’ repeat.</li>
        </ul>

        <p>
          Over time this builds a <strong>map of learning</strong>, not just a list of links â€”
          a record of how consistency, structure, and compounding time turn practice into skill.
        </p>

        <p>
          A dedicated stats view shows graphs for practice sessions, techniques learned,
          and songs studied over time â€” the same Lifeloggerz philosophy applied to music.
        </p>

        <div class="info-modal-close-row">
          <button type="button" class="info-modal-close" id="guitar-help-close">
            Close
          </button>
        </div>
      </div>
    </div>

    <Footer />

    <script>
      (function(){
        const $ = (sel,root=document)=>root.querySelector(sel);
        const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

        /* HERO VIDEO AUDIO LOGIC */
        const heroVideo  = $('.hero-video video');
        const audioBtn   = $('.hero-audio-toggle');

        if (heroVideo) {
          const tryPlay = () => {
            const p = heroVideo.play();
            if (p && typeof p.catch === 'function') {
              p.catch(() => {
                // If autoplay is blocked, we'll just rely on the user clicking the button.
              });
            }
          };

          if (heroVideo.readyState >= 2) {
            tryPlay();
          } else {
            heroVideo.addEventListener('canplay', tryPlay, { once: true });
          }

          if (audioBtn) {
            const updateButton = () => {
              const isMuted = heroVideo.muted;
              audioBtn.dataset.muted = String(isMuted);
              audioBtn.setAttribute('aria-label', isMuted ? 'Unmute video' : 'Mute video');
              const span = audioBtn.querySelector('span');
              if (span) span.textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
            };

            audioBtn.addEventListener('click', () => {
              heroVideo.muted = !heroVideo.muted;
              // If autoplay was blocked earlier, ensure playback starts now
              if (heroVideo.paused) {
                const p = heroVideo.play();
                if (p && typeof p.catch === 'function') p.catch(()=>{});
              }
              updateButton();
            });

            // Initial state
            updateButton();
          }
        }

        const debounce = (fn,ms)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);} };
        const norm = s => (s||"").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

        const grid = $('#grid'), input = $('#q');
        if (!grid || !input) return;

        const cards = $$('.card', grid);
        const haystack = new Map(cards.map(c => [c, norm((c.dataset.title||'')+' '+(c.dataset.note||''))]));

        function filter() {
          const s = norm(input.value.trim());
          if (!s) { cards.forEach(c=>c.style.display=''); return; }
          const words = s.split(/\s+/);
          cards.forEach(c => c.style.display = words.every(w => haystack.get(c).includes(w)) ? '' : 'none');
        }
        input.addEventListener('input', debounce(filter, 80));

        window.addEventListener('keydown', e => {
          if (e.key==='Escape'){ 
            // clear search
            input.value=''; 
            filter(); 
            input.focus();

            // also close modal if open
            const modal = $('#guitar-help-modal');
            if (modal && modal.classList.contains('is-open')) {
              modal.classList.remove('is-open');
              modal.setAttribute('aria-hidden','true');
            }
          }
          else if (e.key==='/' && e.target===document.body){ 
            e.preventDefault(); 
            input.focus(); 
          }
        });
        filter();

        function adjust(bubble){
          if (!bubble) return;
          bubble.style.setProperty('--shift','0px');
          const r = bubble.getBoundingClientRect(), m = 8;
          let shift = 0;
          if (r.left < m) shift = m - r.left;
          else if (r.right > innerWidth - m) shift = (innerWidth - m) - r.right;
          if (shift) bubble.style.setProperty('--shift', `${shift}px`);
        }

        grid.addEventListener('mouseenter', e=>{
          const b = e.target.closest('.card')?.querySelector('.note-bubble');
          if (!b) return;
          requestAnimationFrame(()=>adjust(b));
        }, true);

        grid.addEventListener('focusin', e=>{
          const b = e.target.closest('.card')?.querySelector('.note-bubble');
          if (!b) return;
          requestAnimationFrame(()=>adjust(b));
        });

        addEventListener('resize', ()=> $$('.note-bubble').forEach(adjust));

        document.addEventListener('click', e=>{
          const card = e.target.closest('.card');
          if (!card){ cards.forEach(c=>c.classList.remove('show-note')); return; }
          if (!card.querySelector('.note-bubble')) return;
          if (card.classList.contains('show-note')) return;
          e.preventDefault();
          cards.forEach(c=>c.classList.remove('show-note'));
          card.classList.add('show-note');
          requestAnimationFrame(()=>adjust(card.querySelector('.note-bubble')));
          setTimeout(()=>card.classList.remove('show-note'), 2500);
        }, true);

        /* INFO MODAL LOGIC */
        const helpBtn = $('#guitar-help-btn');
        const modal   = $('#guitar-help-modal');
        const closeBtn= $('#guitar-help-close');

        const openModal = () => {
          if (!modal) return;
          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden','false');
        };
        const closeModal = () => {
          if (!modal) return;
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden','true');
        };

        if (helpBtn && modal) {
          helpBtn.addEventListener('click', openModal);
          if (closeBtn) closeBtn.addEventListener('click', closeModal);
          modal.addEventListener('click', e => {
            if (e.target === modal) closeModal();
          });
        }
      })();
    </script>
  </VideoBg>
</body>
</html>
