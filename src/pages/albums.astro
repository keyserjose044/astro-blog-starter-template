---
// src/pages/albums.astro
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import VideoBg from '../components/VideoBg.astro';
import { SITE_TITLE } from '../consts';

const RAINDROP_TOKEN =
  import.meta.env.RAINDROP_TOKEN ?? '2df3b611-fa2c-4794-a359-1bf08efdd67f';
const COLLECTION_ID =
  import.meta.env.RAINDROP_COLLECTION_ALBUMS_ID ?? '54514878';

async function fetchAllRaindrops() {
  const perPage = 50;
  let page = 0;
  const items: any[] = [];

  try {
    while (true) {
      const res = await fetch(
        `https://api.raindrop.io/rest/v1/raindrops/${COLLECTION_ID}?perpage=${perPage}&page=${page}`,
        { headers: { Authorization: `Bearer ${RAINDROP_TOKEN}` } }
      );

      if (!res.ok) {
        // Log and bail out gracefully instead of killing the build
        let snippet = '';
        try {
          const text = await res.text();
          snippet = text.slice(0, 200);
        } catch {
          // ignore text read errors
        }
        console.warn(
          `Raindrop fetch failed (${res.status}) while building albums: ${snippet}`
        );
        break;
      }

      const json = await res.json();
      const batch = json?.items ?? [];
      if (!batch.length) break;

      items.push(...batch);
      if (batch.length < perPage) break;

      page++;
    }
  } catch (err) {
    console.warn('Raindrop fetch error (network/502/etc) while building albums:', err);
  }

  // Same post-processing as before
  items.sort(
    (a, b) =>
      new Date(b.created || b.lastUpdate || 0).getTime() -
      new Date(a.created || a.lastUpdate || 0).getTime()
  );

  const placeholder = '/images_webp/album-placeholder.webp';
  return items.map((it) => ({
    id: it._id,
    title: it.title ?? 'Untitled',
    href: it.link ?? '#',
    cover: it.cover || it.media?.[0]?.link || placeholder,
    note:
      (typeof it.note === 'string' ? it.note : '') ||
      (typeof it.excerpt === 'string' ? it.excerpt : ''),
    tags: it.tags ?? [],
  }));
}

const albums = await fetchAllRaindrops();
---

<BaseHead
  title={`${SITE_TITLE} â€” Albums`}
  description="Albums gallery powered by Raindrop â€” auto-updated from my collection."
/>

<style>
  :root{--gap:22px;--ink:#0e121b;--muted:#5e6573;--border:#e6e9ef;--surface:#fff}
  *{box-sizing:border-box}
  .wrap{margin:0 auto;padding-block:28px 48px;padding-inline:clamp(16px,3vw,48px);max-width:100%}
  .wrap--wide{width:100dvw;margin-left:calc(50% - 50dvw);margin-right:calc(50% - 50dvw);padding-inline:0}
  .intro{max-width:920px;margin:0 auto 24px;text-align:center;padding-inline:clamp(16px,3vw,48px)}
  h1{margin:0 0 12px;font-weight:800;letter-spacing:-.02em;display:flex;gap:.6rem;align-items:center;justify-content:center}
  .hint{color:var(--muted);margin:6px 0 20px}

  .toolbar{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    margin:6px 0 18px;
    flex-wrap:wrap;
  }
  .toolbar input[type="search"]{
    flex:1 1 260px;
    width:100%;
    max-width:520px;
    margin-inline:0;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--surface);
    color:var(--ink);
    font-size:.95rem;
    box-shadow:0 1px 2px rgba(0,0,0,.03);
  }

  .toolbar select{flex:0 0 auto;min-width:150px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--ink);font-size:.9rem;box-shadow:0 1px 2px rgba(0,0,0,.03);}

  .info-toggle{
    width:40px;
    height:40px;
    border-radius:999px;
    border:1px solid #838796;
    background:#a8adbd;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:1.1rem;
    cursor:pointer;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
    transition:background .15s ease, box-shadow .15s ease, transform .08s ease, border-color .15s ease, color .15s ease;
  }
  .info-toggle span{
    position:relative;
    top:-1px;
    font-weight:600;
  }
  .info-toggle:hover{
    background:#f0f2ff;
    box-shadow:0 4px 10px rgba(0,0,0,.08);
    transform:translateY(-1px);
  }
  .info-toggle[aria-pressed="true"]{
    background:#405cf5;
    color:#fff;
    border-color:#405cf5;
  }

  .info-panel{
    max-width:920px;
    margin:0 auto 24px;
    padding:16px 18px 14px;
    border-radius:14px;
    background:rgba(255,255,255,.9);
    border:1px solid var(--border);
    box-shadow:0 10px 24px rgba(15,23,42,.04);
    font-size:.94rem;
    line-height:1.5;
    color:var(--muted);
    text-align:left;
    display:none;
  }
  .info-panel--visible{display:block;}
  .info-panel h2{
    font-size:1.02rem;
    margin:0 0 .4rem;
    font-weight:700;
    color:var(--ink);
  }
  .info-panel p{margin:.35rem 0;}

  .grid{display:grid;gap:var(--gap);align-items:start;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));max-width:100%}
  @media (min-width:1800px){.grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}}
  .fullbleed{width:100%;margin:0;padding-inline:clamp(16px,3vw,48px)}
  .card{position:relative;display:flex;flex-direction:column;gap:8px;text-decoration:none;color:inherit;border-radius:12px}
  .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);background:#f0f2f7;border:1px solid var(--border)}
  .title{font-weight:700;font-size:.98rem;line-height:1.3}
  .card:focus-visible{outline:2px solid #405cf5;outline-offset:4px;border-radius:12px}
  .note-bubble{position:absolute;left:50%;top:-10px;transform:translate(calc(-50% + var(--shift,0px)),-100%);width:max-content;max-width:min(600px,90vw);white-space:normal;background:rgba(20,23,31,.96);color:#fff;font-size:.9rem;line-height:1.35;padding:10px 12px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:10;pointer-events:none;opacity:0;visibility:hidden;transition:opacity .15s ease,visibility .15s ease;text-align:left;text-wrap:pretty;hyphens:auto;word-break:break-word}
  .note-bubble::after{content:"";position:absolute;left:50%;top:100%;transform:translateX(-50%);border:8px solid transparent;border-top-color:rgba(20,23,31,.96)}
  .card:hover .note-bubble,.card:focus-within .note-bubble,.card.show-note .note-bubble{opacity:1;visibility:visible}
  @media (max-width:700px){
    .note-bubble{top:auto;bottom:-10px;transform:translate(calc(-50% + var(--shift,0px)),100%)}
    .note-bubble::after{top:auto;bottom:100%;border-top-color:transparent;border-bottom-color:rgba(20,23,31,.96)}
  }
  .empty{text-align:center;color:var(--muted);padding:40px 0 24px}
</style>

<VideoBg>
  <Header />
  <main class="wrap wrap--wide">
    <div class="intro" role="region" aria-label="Albums header">
      <h1>ðŸŽµ Albums</h1>
      <p class="hint">
        My life in {(albums.length).toLocaleString('en-US')} albums â€” every listen logged and displayed here.
      </p>
      
      <div class="toolbar">
        <input
          id="q"
          type="search"
          placeholder="Search title or noteâ€¦"
          aria-label="Filter albums"
        />
        <select id="genre-filter" aria-label="Filter by style">
          <option value="">All styles</option>
        </select>
      
        <button
          type="button"
          id="info-toggle"
          class="info-toggle"
          aria-label="About my listening"
          aria-expanded="false"
          aria-pressed="false"
        >
          <span>?</span>
        </button>
      
        <a
          href="/stats/?metric=music&year=current#graphs"
          class="info-toggle"
          aria-label="View music stats"
          title="View music stats"
        >
          ðŸ“Š
        </a>
      </div>

      <section id="albums-info" class="info-panel" hidden>
        <h2>Why I Log Albums</h2>
        <p>
          Music is the other half of my attention economy. I donâ€™t listen passively â€” I log albums the way I log
          books, as a record of whatâ€™s been in my ears while I walk, work, or drive.
        </p>

        <h2>Whatâ€™s in Here</h2>
        <p>
          These are full albums, not shuffled playlists. I drift through classical, film scores, jazz, folk, and
          anything that grabs my curiosity hard enough to deserve a front-to-back listen.
        </p>

        <h2>How to Read This Grid</h2>
        <p>
          Hover over a cover to see my structured note:
          <strong>Date Â· Album Â· Artist Â· Year Â· Style Â· Country Â· Length Â· Context</strong>.
        </p>
        <p>
          On mobile, tap once to reveal the note, then tap again to follow the link (usually to a streaming or
          reference page).
        </p>

        <h2>Future Stats</h2>
        <p>
          Later Iâ€™ll surface live listening stats here: most-played artists, years, genres, and streaks powered by my
          Google Sheets logs.
        </p>
      </section>
    </div>

    {albums.length === 0 ? (
      <div class="empty">
        Albums are temporarily unavailable â€” either Raindrop returned no items or its API hiccuped during build.
      </div>
    ) : (
      <div class="grid fullbleed" id="grid" role="list">
        {albums.map((a) => (
          <a
            class="card"
            role="listitem"
            href={a.href}
            target="_blank"
            rel="noopener noreferrer"
            title={a.title}
            data-title={a.title.toLowerCase()}
            data-note={(a.note || '').toLowerCase()}
            data-note-raw={a.note || ''}
          >
            <img
              class="thumb"
              src={a.cover}
              alt={a.title}
              loading="lazy"
              decoding="async"
              sizes="(min-width: 1800px) 300px, (min-width: 900px) 25vw, 50vw"
            />
            <div class="title">{a.title}</div>
            {a.note ? (
              <div class="note-bubble" role="tooltip">
                {a.note}
              </div>
            ) : null}
          </a>
        ))}
      </div>
    )}
  </main>
  <Footer />
</VideoBg>

<script>
  (function(){
    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    const debounce = (fn,ms)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);} };
    const norm = s => (s||"").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

    const grid = $('#grid');
    const input = $('#q');
    const genreSelect = $('#genre-filter');
    if (!grid || !input) return;

    const cards = $$('.card', grid);
    const haystack = new Map(cards.map(c => [c, norm((c.dataset.title||'')+' '+(c.dataset.note||''))]));

    // ðŸ”¹ Canonical style list (order matters)
    const CANONICAL_STYLES = [
      'Pop',
      'Rock',
      'Hip-Hop/Rap',
      'R&B/Soul',
      'Electronic/Dance',
      'Jazz',
      'Classical',
      'Country',
      'Folk/Acoustic',
      'Blues',
      'Metal',
      'Reggae/Ska',
      'Latin',
      'World/Global',
      'Punk',
      'Funk',
      'Gospel/Christian',
      'Soundtrack/Film Score',
      'New Age/Ambient',
      'Experimental/Avant-Garde',
    ];

    // ðŸ”¹ Alias map in case Raindrop notes use slightly different punctuation
    const STYLE_ALIAS_MAP = {};
    STYLE_ALIAS_MAP[norm('Hip Hop/Rap')] = 'Hip-Hop/Rap';
    STYLE_ALIAS_MAP[norm('Hip-Hop/Rap')] = 'Hip-Hop/Rap';
    STYLE_ALIAS_MAP[norm('R&B / Soul')] = 'R&B/Soul';
    STYLE_ALIAS_MAP[norm('R&amp;B/Soul')] = 'R&B/Soul';
    STYLE_ALIAS_MAP[norm('Electronic / Dance')] = 'Electronic/Dance';
    STYLE_ALIAS_MAP[norm('EDM/Electronic')] = 'Electronic/Dance';
    STYLE_ALIAS_MAP[norm('Folk')] = 'Folk/Acoustic';
    STYLE_ALIAS_MAP[norm('Acoustic/Folk')] = 'Folk/Acoustic';
    STYLE_ALIAS_MAP[norm('Reggae & Ska')] = 'Reggae/Ska';
    STYLE_ALIAS_MAP[norm('World')] = 'World/Global';
    STYLE_ALIAS_MAP[norm('Global/World')] = 'World/Global';
    STYLE_ALIAS_MAP[norm('Gospel / Christian')] = 'Gospel/Christian';
    STYLE_ALIAS_MAP[norm('Film Score/Soundtrack')] = 'Soundtrack/Film Score';
    STYLE_ALIAS_MAP[norm('Soundtrack')] = 'Soundtrack/Film Score';
    STYLE_ALIAS_MAP[norm('New Age / Ambient')] = 'New Age/Ambient';
    STYLE_ALIAS_MAP[norm('Ambient/New Age')] = 'New Age/Ambient';
    STYLE_ALIAS_MAP[norm('Experimental')] = 'Experimental/Avant-Garde';
    STYLE_ALIAS_MAP[norm('Avant-Garde')] = 'Experimental/Avant-Garde';

    const stylesInUse = new Set();

    // ðŸ”¹ Extract style from note (5th field) and attach to each card
    // Note format: Date Â· Album Â· Artist Â· Year Â· Style Â· Country Â· Length Â· Context
    cards.forEach(c => {
      const raw = c.dataset.noteRaw || '';
      const parts = raw.split('Â·').map(s => s.trim());
      if (parts.length < 5) return;

      const rawStyle = parts[4];
      const rawNorm = norm(rawStyle);

      // Exact match first
      let canonical = CANONICAL_STYLES.find(g => norm(g) === rawNorm);

      // Fallback to alias map
      if (!canonical && STYLE_ALIAS_MAP[rawNorm]) {
        canonical = STYLE_ALIAS_MAP[rawNorm];
      }

      if (!canonical) return; // ignore weird styles

      const styleKey = norm(canonical);
      c.dataset.genre = canonical;
      c.dataset.genreKey = styleKey;
      stylesInUse.add(canonical);
    });

    // ðŸ”¹ Populate dropdown using canonical order, but only styles actually present
    if (genreSelect) {
      const used = CANONICAL_STYLES.filter(g => stylesInUse.has(g));
      used.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g;
        opt.textContent = g;
        genreSelect.appendChild(opt);
      });
    }

    function filter() {
      const s = norm(input.value.trim());
      const selected = genreSelect ? genreSelect.value : '';
      const selectedKey = norm(selected);

      cards.forEach(c => {
        const textMatches = !s || s.split(/\s+/).every(w => haystack.get(c).includes(w));
        const styleMatches = !selected || (c.dataset.genreKey && c.dataset.genreKey === selectedKey);
        c.style.display = (textMatches && styleMatches) ? '' : 'none';
      });
    }

    input.addEventListener('input', debounce(filter, 80));
    if (genreSelect) {
      genreSelect.addEventListener('change', filter);
    }

    window.addEventListener('keydown', e => {
      if (e.key==='Escape'){
        input.value='';
        if (genreSelect) genreSelect.value = '';
        filter();
        input.focus();
      } else if (e.key==='/' && e.target===document.body){
        e.preventDefault();
        input.focus();
      }
    });

    filter();

    // Tooltip positioning (unchanged)
    function adjust(bubble){
      if (!bubble) return;
      bubble.style.setProperty('--shift','0px');
      const r = bubble.getBoundingClientRect(), m = 8;
      let shift = 0;
      if (r.left < m) shift = m - r.left;
      else if (r.right > innerWidth - m) shift = (innerWidth - m) - r.right;
      if (shift) bubble.style.setProperty('--shift', `${shift}px`);
    }
    grid.addEventListener('mouseenter', e=>{
      const b = e.target.closest('.card')?.querySelector('.note-bubble'); if (!b) return;
      requestAnimationFrame(()=>adjust(b));
    }, true);
    grid.addEventListener('focusin', e=>{
      const b = e.target.closest('.card')?.querySelector('.note-bubble'); if (!b) return;
      requestAnimationFrame(()=>adjust(b));
    });
    addEventListener('resize', ()=> $$('.note-bubble').forEach(adjust));

    // Mobile tap-to-show tooltip (unchanged)
    document.addEventListener('click', e=>{
      const card = e.target.closest('.card');
      if (!card){ cards.forEach(c=>c.classList.remove('show-note')); return; }
      if (!card.querySelector('.note-bubble')) return;
      if (card.classList.contains('show-note')) return;
      e.preventDefault();
      cards.forEach(c=>c.classList.remove('show-note'));
      card.classList.add('show-note');
      requestAnimationFrame(()=>adjust(card.querySelector('.note-bubble')));
      setTimeout(()=>card.classList.remove('show-note'), 2500);
    }, true);

    const infoBtn = $('#info-toggle');
    const infoPanel = $('#albums-info');
    if (infoBtn && infoPanel){
      infoBtn.addEventListener('click', ()=>{
        const isOpen = infoPanel.classList.toggle('info-panel--visible');
        infoPanel.hidden = !isOpen;
        infoBtn.setAttribute('aria-pressed', isOpen ? 'true' : 'false');
        infoBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        if (isOpen){
          infoPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    }
  })();
</script>

