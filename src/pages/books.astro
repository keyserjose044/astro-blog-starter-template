---
// src/pages/books.astro
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE } from '../consts';

const RAINDROP_TOKEN = import.meta.env.RAINDROP_TOKEN ?? "2df3b611-fa2c-4794-a359-1bf08efdd67f";
const COLLECTION_ID  = import.meta.env.RAINDROP_COLLECTION_books_ID ?? "54514877";

async function fetchAllRaindrops() {
  const perPage = 50;
  let page = 0, items = [];
  while (true) {
    const res = await fetch(
      `https://api.raindrop.io/rest/v1/raindrops/${COLLECTION_ID}?perpage=${perPage}&page=${page}`,
      { headers: { Authorization: `Bearer ${RAINDROP_TOKEN}` } }
    );
    if (!res.ok) throw new Error(await res.text());
    const batch = (await res.json())?.items ?? [];
    if (!batch.length) break;
    items.push(...batch);
    if (batch.length < perPage) break;
    page++;
  }
  items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));
  const ph = '/images/books-placeholder.png';
  return items.map(it=>({
    title: it.title ?? 'Untitled',
    href: it.link ?? '#',
    cover: it.cover || it.media?.[0]?.link || ph,
    note: it.note || it.excerpt || ''
  }));
}
const books = await fetchAllRaindrops();
---

<!doctype html>
<html lang="en">
<head>
  <BaseHead title={`${SITE_TITLE} â€” books`} />
  <style>
    :root{--b:#e6e9ef;--m:#5e6573;--ink:#111;}
    body{margin:0;font-family:system-ui;background:#f6f8fb;color:var(--ink)}
    .wrap{max-width:100%;padding:28px clamp(16px,3vw,48px)}
    .intro{text-align:center;max-width:900px;margin:0 auto}
    h1{margin:0 0 12px;font-weight:800;display:flex;justify-content:center;gap:.5rem}
    .hint{color:var(--m);margin-bottom:20px}

    /* toolbar */
    .toolbar{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:18px}
    .toolbar input{max-width:520px;width:100%;padding:12px 14px;border:1px solid var(--b);
      border-radius:12px;background:#fff;font-size:.95rem}

    /* toggle + panel */
    .info-toggle{width:40px;height:40px;border-radius:50%;border:1px solid var(--b);background:#fff;
      display:flex;align-items:center;justify-content:center;font-weight:600;cursor:pointer}
    .info-toggle[aria-pressed="true"]{background:#405cf5;color:#fff;border-color:#405cf5}
    .info-panel{display:none;max-width:900px;margin:0 auto 24px;padding:14px 18px;border:1px solid var(--b);
      border-radius:14px;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,.05);color:var(--m);font-size:.93rem}
    .info-panel h2{margin:.3rem 0 .2rem;font-size:1rem;color:var(--ink)}
    .info-panel--visible{display:block}

    /* gallery grid */
    .grid{display:grid;gap:22px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{text-decoration:none;color:inherit;display:flex;flex-direction:column;gap:8px}
    .thumb{aspect-ratio:3/4;object-fit:cover;border-radius:12px;border:1px solid var(--b);
      box-shadow:0 6px 14px rgba(0,0,0,.12)}
    .title{font-weight:700;font-size:.98rem}

    /* tooltip */
    .note-bubble{position:absolute;background:#111;color:#fff;padding:8px 10px;border-radius:8px;
      font-size:.85rem;opacity:0;visibility:hidden;transition:.15s}
    .card:hover .note-bubble{opacity:1;visibility:visible}
    .card{position:relative}
  </style>
</head>

<body>
<Header />
<main class="wrap">

  <div class="intro">
    <h1>ðŸ“š Books</h1>
    <p class="hint">{books.length} Audiobooks listened to since 2023.</p>

    <div class="toolbar">
      <input id="q" type="search" placeholder="Search title or noteâ€¦" />
      <button id="info-toggle" class="info-toggle" aria-pressed="false">?</button>
    </div>

    <section id="reading-info" class="info-panel" hidden>
      <h2>Why I Listen</h2>
      <p>I donâ€™t watch TV or scroll social media. Audiobooks turn driving, washing, and running into meaningful hours.</p>

      <h2>What I Read</h2>
      <p>I follow curiosity, not a plan: classics, philosophy, history, psychology, religion, fantasy, and more.</p>

      <h2>The Numbers</h2>
      <p>Since Feb 9, 2023: ~300 audiobooks and over 2,000 hours logged. Nearly three years of continuous listening.</p>
    </section>
  </div>

  <div class="grid" id="grid">
    {books.map(a => (
      <a class="card" href={a.href} target="_blank" data-title={a.title.toLowerCase()} data-note={a.note.toLowerCase()}>
        <img class="thumb" src={a.cover} alt={a.title} />
        <div class="title">{a.title}</div>
        {a.note ? <div class="note-bubble">{a.note}</div> : null}
      </a>
    ))}
  </div>

</main>
<Footer />

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const $$ = s=>[...document.querySelectorAll(s)];

  // Filter
  const input = $('#q'), cards = $$('.card');
  const data = new Map(cards.map(c=>[c,(c.dataset.title+" "+c.dataset.note).toLowerCase()]));
  input.addEventListener('input', ()=>{
    const q = input.value.toLowerCase();
    cards.forEach(c=>c.style.display = data.get(c).includes(q) ? '' : 'none');
  });

  // Info panel toggle
  const btn = $('#info-toggle'), panel = $('#reading-info');
  btn.onclick = ()=>{
    const open = panel.classList.toggle('info-panel--visible');
    panel.hidden = !open;
    btn.setAttribute('aria-pressed', open);
    if(open) panel.scrollIntoView({behavior:'smooth'});
  };
})();
</script>

</body>
</html>
