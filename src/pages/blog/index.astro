---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';
import VideoBg from '../../components/VideoBg.astro';
import BlogCard from '../../components/BlogCard.astro';


// Exclude drafts and sort safely
const posts = (await getCollection('blog', ({ data }) => data?.draft !== true))
  .map((p) => ({
    ...p,
    _pub: p.data?.pubDate instanceof Date
      ? p.data.pubDate
      : new Date(p.data?.pubDate ?? 0),
  }))
  .sort((a, b) => (b._pub?.getTime?.() ?? 0) - (a._pub?.getTime?.() ?? 0));
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`${SITE_TITLE} â€” Blog`} description={SITE_DESCRIPTION} />
    <style>
      :root {
        --list-max: clamp(70ch, 96vw, 1280px); /* desktop container */
        --read-max: 72ch;                      /* phone container */
        --border: #e6e9ef;
        --thumb-radius: 16px;
        --thumb-shadow: 0 10px 30px rgba(0,0,0,.12);
      }

      html,
      body {
        max-width: 100%;
        overflow-x: hidden;
      }

      main {
        min-height: 100vh;
      }

      .wrap {
        max-width: var(--list-max);
        margin: 0 auto;
        padding: 4rem 1.5rem 5rem;
      }

      @media (max-width: 640px) {
        .wrap {
          padding-inline: 1.25rem;
          padding-top: 3.25rem;
          padding-bottom: 4rem;
        }
      }

      .intro h1 {
        font-size: clamp(2rem, 4vw, 2.4rem);
        margin: 0 0 0.5rem;
        letter-spacing: -0.03em;
      }

      .intro p {
        max-width: 38rem;
        color: #4b5563;
        margin: 0 0 1.75rem;
        font-size: 0.95rem;
      }

      .toolbar {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
        margin-top: 0.75rem;
      }

      @media (min-width: 640px) {
        .toolbar {
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
        }
      }
      
      .toolbar input[type='search'] {
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 0.5rem 0.9rem;
        font-size: 0.9rem;
        min-width: min(260px, 100%);
      
        /* Restore original LL look */
        background: #ffffff;
        color: #111111;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
      }
      
      .toolbar input[type='search']::placeholder {
        color: #666666; /* light grey placeholder */
      }
      
      .toolbar input[type='search']:focus {
        outline: none;
        border-color: #38bdf8;
        box-shadow:
          0 0 0 1px rgba(56, 189, 248, 0.7),
          0 0 32px rgba(56, 189, 248, 0.3);
      }

      .toolbar small {
        display: block;
        margin-top: 0.4rem;
        color: #9ca3af;
      }

      .empty {
        display: none;
        margin: 2rem 0;
        color: #6b7280;
        font-style: italic;
      }
      
      ul#grid {
        list-style: none;
        padding: 0;
        margin: 1.75rem 0 0;
        display: grid;
        gap: 1.75rem;
      }
      
      /* Mobile: 1 card per row */
      @media (max-width: 767px) {
        ul#grid {
          grid-template-columns: 1fr;
        }
      }
      
      /* Tablet / small laptop: 2 cards per row */
      @media (min-width: 768px) and (max-width: 1199px) {
        ul#grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      
      /* Desktop: 3 cards per row */
      @media (min-width: 1200px) {
        ul#grid {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }

    </style>
  </head>

  <body>
    <VideoBg>
      <Header />
      <main>
        <section class="wrap">
          <div class="intro" role="region" aria-label="Blog header">
            <h1>Blog Posts</h1>

            <div class="toolbar">
              <input
                id="q"
                type="search"
                placeholder="Search"
                aria-label="Filter blog posts"
              />
              <small>Press "/" to focus search, "Esc" to clear.</small>
            </div>


          </div>

          <div class="empty" id="empty">No posts match your search.</div>
          
          <ul id="grid">
            {posts.map((post) => {
              const title = post.data.title ?? '';
              const heroImage = post.data.heroImage;
              const heroVideo = (post.data as any).heroVideo; // optional
              const desc =
                (post.data as any).description ||
                (post.data as any).summary ||
                '';
          
              return (
               <li>
                <BlogCard
                  href={`/blog/${post.slug}/`}
                  title={title}
                  pubDate={post._pub}
                  heroImage={heroImage}
                  heroVideo={heroVideo}
                  data-title={title.toLowerCase()}
                />
              </li>
              );
            })}
          </ul>

        </section>
      </main>
      <Footer />
    </VideoBg>

    <script>
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const norm = (s) =>
          (s || '')
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');
        const debounce = (fn, ms) => {
          let t;
          return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
          };
        };

        /* ====== SEARCH ====== */

        const input = $('#q');
        const empty = $('#empty');
        const items = $$('#grid [data-title]');

        function applyFilter() {
          if (!items.length || !input) return;

          const query = norm(input.value);
          let visibleCount = 0;

          items.forEach((el) => {
            const title = norm(el.getAttribute('data-title') || '');
            const matches = !query || title.includes(query);
            const li = el.closest('li') || el;

            if (matches) {
              li.style.display = '';
              visibleCount += 1;
            } else {
              li.style.display = 'none';
            }
          });

          if (empty) {
            empty.style.display = visibleCount ? 'none' : 'block';
          }
        }

        if (input) {
          input.addEventListener('input', debounce(applyFilter, 80));
          window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              input.value = '';
              applyFilter();
              input.focus();
            } else if (e.key === '/' && e.target === document.body) {
              e.preventDefault();
              input.focus();
            }
          });
        }

        applyFilter();

      })();
    </script>
  </body>
</html>
