---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';
import VideoBg from '../../components/VideoBg.astro';

// Exclude drafts and sort safely
const posts = (await getCollection('blog', ({ data }) => data?.draft !== true))
  .map((p) => ({
    ...p,
    _pub: p.data?.pubDate instanceof Date
      ? p.data.pubDate
      : new Date(p.data?.pubDate ?? 0),
  }))
  .sort((a, b) => (b._pub?.getTime?.() ?? 0) - (a._pub?.getTime?.() ?? 0));
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`${SITE_TITLE} â€” Blog`} description={SITE_DESCRIPTION} />
    <style>
      :root {
        --list-max: clamp(60ch, 90vw, 1100px); /* desktop container */
        --read-max: 72ch;                      /* phone container */
        --border: #e6e9ef;
        --thumb-radius: 16px;
        --thumb-shadow: 0 10px 30px rgba(0,0,0,.12);
      }

      html, body { max-width: 100%; overflow-x: hidden; }
      main { width: 100%; margin: 0; }

      .wrap {
        width: 100%;
        max-width: var(--list-max);
        margin: 0 auto 2.5rem;
        padding: 1rem 1.25rem 2.5rem;
        box-sizing: border-box;
      }

      @media (max-width: 480px) {
        .wrap {
          max-width: var(--read-max);
          padding-inline: 1rem;
        }
      }

      .intro {
        padding: 2.2rem 0 1.5rem;
      }

      .intro h1 {
        margin: 0 0 0.5rem;
        font-size: clamp(2rem, 4vw, 2.5rem);
      }

      .intro p {
        margin: 0.2rem 0 0;
        color: #6b7280;
      }

      .toolbar {
        margin: 1.25rem 0 0;
      }

      .toolbar input[type="search"] {
        width: 100%;
        max-width: 520px;
        padding: 12px 40px 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff
          url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path fill="%23767f8b" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16.5 9.5 6.5 6.5 0 1 0 10 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-4.5-4.5ZM4 10.5a6.5 6.5 0 1 1 13 0a6.5 6.5 0 0 1-13 0Z"/></svg>')
          no-repeat right 12px center;
        background-size: 18px;
        color: #0e121b;
        font-size: .95rem;
        box-sizing: border-box;
      }

      .toolbar input[type="search"]::placeholder {
        color: #9ca3af;
      }

      .toolbar small {
        display: block;
        margin-top: 0.4rem;
        color: #9ca3af;
      }

      .empty {
        display: none;
        margin: 2rem 0;
        color: #6b7280;
        font-style: italic;
      }

      ul#grid {
        list-style: none;
        padding: 0;
        margin: 1.75rem 0 0;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      @media (min-width: 900px) {
        ul#grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
          gap: 1.5rem;
        }
      }

      li {
        margin: 0;
      }

      li a {
        display: block;
        text-decoration: none;
        color: inherit;
        border-radius: var(--thumb-radius);
        overflow: hidden;
        background: #fff;
        box-shadow: var(--thumb-shadow);
        transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
        border: 1px solid rgba(15,23,42,0.04);
      }

      li a:hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 36px rgba(0,0,0,0.18);
        border-color: rgba(15,23,42,0.08);
      }

      .thumb-frame {
        width: 100%;
        height: 180px;
        overflow: hidden;
        background: #020617;
      }

      @media (max-width: 480px) {
        .thumb-frame {
          height: 180px;
        }
      }

      .thumb-media {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .card-body {
        padding: 0.9rem 1.1rem 1.1rem;
      }

      .card-body h2 {
        font-size: 1.12rem;
        margin: 0 0 0.35rem;
      }

      .card-meta {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #6b7280;
      }

      .card-meta time {
        white-space: nowrap;
      }

      .card-tagline {
        margin: 0.5rem 0 0;
        font-size: 0.92rem;
        color: #4b5563;
      }

      @media (max-width: 480px) {
        .card-body {
          padding-inline: 0.9rem;
        }
      }
    </style>
  </head>

  <body>
    <VideoBg>
      <Header />
      <main>
        <section class="wrap">
          <div class="intro" role="region" aria-label="Blog header">
            <h1>Blog Posts</h1>
            <div class="toolbar">
              <input
                id="q"
                type="search"
                placeholder="Search"
                aria-label="Filter blog posts"
              />
              <small>Press "/" to focus search, "Esc" to clear.</small>
            </div>
          </div>

          <div class="empty" id="empty">No posts match your search.</div>

          <ul id="grid">
            {posts.map((post) => {
              const title = post.data.title ?? '';
              const heroImage = post.data.heroImage;
              const heroVideo = (post.data as any).heroVideo; // optional
              const desc =
                (post.data as any).description ||
                (post.data as any).summary ||
                '';

              return (
                <li data-title={title.toLowerCase()}>
                  <a href={`/blog/${post.slug}/`}>
                    {(heroImage || heroVideo) && (
                      <div class="thumb-frame">
                        {heroImage ? (
                          <img
                            class="thumb-media"
                            src={heroImage}
                            alt=""
                            loading="lazy"
                          />
                        ) : heroVideo ? (
                          <video
                            class="thumb-media"
                            autoplay
                            muted
                            loop
                            playsinline
                            preload="auto"
                          >
                            <source src={heroVideo} type="video/mp4" />
                          </video>
                        ) : null}
                      </div>
                    )}

                    <div class="card-body">
                      <h2>{title}</h2>
                      <div class="card-meta">
                        {post._pub ? (
                          <time datetime={post._pub.toISOString()}>
                            {post._pub.toLocaleDateString(undefined, {
                              year: 'numeric',
                              month: 'short',
                              day: 'numeric',
                            })}
                          </time>
                        ) : (
                          <time aria-hidden="true">Undated</time>
                        )}
                        <span>
                          <FormattedDate date={post._pub ?? new Date()} />
                        </span>
                      </div>
                      {desc && <p class="card-tagline">{desc}</p>}
                    </div>
                  </a>
                </li>
              );
            })}
          </ul>
        </section>
      </main>
      <Footer />
    </VideoBg>

    <script>
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const norm = (s) =>
          (s || '')
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');
        const debounce = (fn, ms) => {
          let t;
          return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
          };
        };

        const input = $('#q');
        const items = $$('ul#grid > li');
        const empty = $('#empty');
        if (!input || !items.length || !empty) return;

        function filter() {
          const q = norm(input.value);
          let shown = 0;
          items.forEach((li) => {
            const title = norm(li.dataset.title || '');
            const match = !q || title.includes(q);
            li.style.display = match ? '' : 'none';
            if (match) shown++;
          });
          empty.style.display = shown ? 'none' : '';
        }

        input.addEventListener('input', debounce(filter, 80));
        window.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            input.value = '';
            filter();
            input.focus();
          } else if (e.key === '/' && e.target === document.body) {
            e.preventDefault();
            input.focus();
          }
        });
        filter();
      })();
    </script>
  </body>
</html>
