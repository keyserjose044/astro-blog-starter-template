---
/* src/pages/index.astro */
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE } from '../consts';

// Load non-draft posts and sort newest → oldest (robust to missing pubDate)
const rawPosts = await getCollection('blog', ({ data }) => data?.draft !== true);

const posts = rawPosts
  .map((p) => {
    const raw = p.data?.pubDate;
    const asDate = raw instanceof Date ? raw : raw ? new Date(raw) : null;
    const validDate = asDate && !Number.isNaN(asDate.valueOf()) ? asDate : null;
    return { ...p, _pub: validDate };
  })
  .sort((a, b) => (b._pub?.getTime?.() ?? 0) - (a._pub?.getTime?.() ?? 0))
  .slice(0, 3); // ⟵ only show 3 on Home
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} />
  </head>
  <body>
    <Header />
    <main>
      <!-- Hero -->
      <section style="text-align:center; margin: 3rem 0 2rem; padding: 0 1rem;">
        <h1 style="font-size:clamp(2rem,4vw,3rem); margin:0 0 .5rem;">
          Dr. Rohitashva K. Singh
        </h1>
        <p style="opacity:.9; font-size:1.125rem; margin:0 0 .35rem;">
          Materials & structural engineer focused on nano-reinforced cementitious composites,
          sustainable concrete, and concrete rheology.
        </p>
        <p style="opacity:.8; font-size:0.98rem; margin:0.15rem 0 0;">
          PhD in Civil Engineering (Structural), The University of Texas at Arlington, USA (2021–2025).<br />
          Seeking 2026 opportunities in advanced cementitious materials for sustainable, resilient infrastructure.
        </p>

        <div style="margin-top:1.25rem; display:flex; justify-content:center; gap:0.75rem; flex-wrap:wrap;">
          <a
            href="/cv"
            style="
              display:inline-block;
              padding:0.55rem 1.3rem;
              border-radius:999px;
              text-decoration:none;
              font-weight:600;
              background:#111;
              color:#fff;
            "
          >
            View CV
          </a>
          <a
            href="/publications"
            style="
              display:inline-block;
              padding:0.55rem 1.3rem;
              border-radius:999px;
              text-decoration:none;
              font-weight:500;
              border:1px solid rgba(0,0,0,.15);
              background:#fff;
              color:#111;
            "
          >
            Publications
          </a>
        </div>
      </section>

      <!-- Latest posts teaser -->
      <section style="padding: 0 1rem;">
        <div style="display:flex; justify-content:space-between; align-items:baseline; gap:1rem;">
          <h2 style="margin:0;">Latest writing & updates</h2>
          <a
            href="/blog"
            style="font-weight:700; text-decoration:underline; text-underline-offset:3px;"
          >
            All posts →
          </a>
        </div>

        {posts.length === 0 ? (
          <p style="margin-top:0.75rem; opacity:.8;">
            No posts have been published yet. Check back soon for research news, publications,
            and conference updates.
          </p>
        ) : (
          <ul class="post-grid">
            {posts.map((post) => (
              <li class="card">
                <a href={`/blog/${post.slug}/`} aria-label={post.data.title}>
                  {post.data.heroImage ? (
                    <img src={post.data.heroImage} alt="" loading="lazy" />
                  ) : post.data.heroVideo ? (
                    <video
                      autoplay
                      muted
                      loop
                      playsinline
                      preload="auto"
                    >
                      <source src={post.data.heroVideo} type="video/mp4" />
                    </video>
                  ) : null}
                  <h3>{post.data.title}</h3>
                  {post._pub ? (
                    <time datetime={post._pub.toISOString()}>
                      {post._pub.toLocaleDateString(undefined, {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                      })}
                    </time>
                  ) : (
                    <time aria-hidden="true">Undated</time>
                  )}
                </a>
              </li>
            ))}
          </ul>
        )}
      </section>
    </main>
    <Footer />
  </body>
</html>

<style>
  .post-grid {
    list-style: none;
    padding: 0;
    margin: 1.25rem 0 2.5rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
  }
  .card a {
    display: block;
    text-decoration: none;
    color: inherit;
    border-radius: 16px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 8px 24px rgba(0,0,0,.08);
  }
  .card img,
  .card video {
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
  }
  .card h3 {
    margin: 0.75rem 1rem 0.25rem;
    font-size: 1.25rem;
  }
  .card time {
    display: block;
    margin: 0 1rem 1rem;
    opacity: .7;
  }
</style>
