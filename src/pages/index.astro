---
/* src/pages/index.astro */
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import VideoBg from '../components/VideoBg.astro';   // ← NEW
import HeroTitleRipple from '../components/HeroTitleRipple.astro';
import SeeAllPill from '../components/SeeAllPill.astro';
import BlogCard from '../components/BlogCard.astro';
import { SITE_TITLE } from '../consts';

// Load non-draft posts and sort newest → oldest
const rawPosts = await getCollection('blog', ({ data }) => data?.draft !== true);

const posts = rawPosts
  .map((p) => {
    const raw = p.data?.pubDate;
    const asDate = raw instanceof Date ? raw : raw ? new Date(raw) : null;
    const validDate = asDate && !Number.isNaN(asDate.valueOf()) ? asDate : null;
    return { ...p, _pub: validDate };
  })
  .sort((a, b) => (b._pub?.getTime?.() ?? 0) - (a._pub?.getTime?.() ?? 0))
  .slice(0, 4);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} />
  </head>

  <body>
    <VideoBg>
      <Header />

      <main>
        <!-- Hero -->
        <section style="text-align:center; margin: 3rem 0 2rem;">
          <HeroTitleRipple
            as="h1"
            style="font-size:clamp(2rem,4vw,3rem); margin:0 0 .5rem; display:inline-block;"
          >
            LifeLoggerz
          </HeroTitleRipple>
        
          <p style="opacity:.8; font-size:1.125rem;">
            Systems, templates, and experiments in hyper-efficient living
          </p>
        </section>

        <!-- Latest posts -->
        <section>
          <div class="home-section-header">
            <h2 class="home-section-title">Latest from the Blog</h2>
            <SeeAllPill href="/blog" />
          </div>

          {posts.length === 0 ? (
            <p>No posts yet. Add some markdown files to <code>src/content/blog/</code>!</p>
          ) : (
            <ul class="post-grid">
              {posts.map((post) => (
                <BlogCard
                  href={`/blog/${post.slug}/`}
                  title={post.data.title}
                  pubDate={post._pub}
                  heroImage={post.data.heroImage}
                  heroVideo={post.data.heroVideo}
                />
              ))}
            </ul>
          )}
        </section>
      </main>

      <Footer />
    </VideoBg>
  </body>
</html>

<style>
  .post-grid {
    list-style: none;
    padding: 0;
    margin: 1rem 0 2.25rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
  }

  .home-section-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .home-section-title {
    margin: 0;
  }

  @media (max-width: 639px) {
    .home-section-header {
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
      text-align: center;
    }
  }
</style>

