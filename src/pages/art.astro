---
// src/pages/art.astro
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import VideoBg from '../components/VideoBg.astro';
import { SITE_TITLE } from '../consts';

const RAINDROP_TOKEN =
  import.meta.env.RAINDROP_TOKEN ?? '2df3b611-fa2c-4794-a359-1bf08efdd67f';
const COLLECTION_ID =
  import.meta.env.RAINDROP_COLLECTION_ART_ID ?? '58506976';

async function fetchAllRaindrops() {
  const perPage = 50;
  let page = 0,
    items: any[] = [];
  while (true) {
    const res = await fetch(
      `https://api.raindrop.io/rest/v1/raindrops/${COLLECTION_ID}?perpage=${perPage}&page=${page}`,
      { headers: { Authorization: `Bearer ${RAINDROP_TOKEN}` } }
    );
    if (!res.ok)
      throw new Error(
        `Raindrop fetch failed (${res.status}): ${await res.text()}`
      );
    const batch = (await res.json())?.items ?? [];
    if (!batch.length) break;
    items.push(...batch);
    if (batch.length < perPage) break;
    page++;
  }
  items.sort(
    (a, b) =>
      new Date(b.created || b.lastUpdate || 0).getTime() -
      new Date(a.created || a.lastUpdate || 0).getTime()
  );
  const placeholder = '/images_webp/art-placeholder.webp';
  return items.map((it) => ({
    id: it._id,
    title: it.title ?? 'Untitled',
    href: it.link ?? '#',
    cover: it.cover || it.media?.[0]?.link || placeholder,
    note:
      (typeof it.note === 'string' ? it.note : '') ||
      (typeof it.excerpt === 'string' ? it.excerpt : ''),
    tags: it.tags ?? [],
  }));
}
const art = await fetchAllRaindrops();
---

<BaseHead
  title={`${SITE_TITLE} â€” Art`}
  description="Art gallery powered by Raindrop â€” auto-updated from my collection."
/>

<style>
  :root{--gap:22px;--ink:#0e121b;--muted:#5e6573;--border:#e6e9ef;--surface:#fff}
  *{box-sizing:border-box}
  .wrap{margin:0 auto;padding-block:28px 48px;padding-inline:clamp(16px,3vw,48px);max-width:100%}
  .wrap--wide{width:100dvw;margin-left:calc(50% - 50dvw);margin-right:calc(50% - 50dvw);padding-inline:0}
  .intro{max-width:920px;margin:0 auto 24px;text-align:center;padding-inline:clamp(16px,3vw,48px)}
  h1{margin:0 0 12px;font-weight:800;letter-spacing:-.02em;display:flex;gap:.6rem;align-items:center;justify-content:center}
  .hint{color:var(--muted);margin:6px 0 20px}

  .toolbar{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    margin:6px 0 18px;
    flex-wrap:wrap;
  }
  .toolbar input[type="search"]{
    flex:1 1 260px;
    width:100%;
    max-width:520px;
    margin-inline:0;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--surface);
    color:var(--ink);
    font-size:.95rem;
    box-shadow:0 1px 2px rgba(0,0,0,.03);
  }

  .toolbar select{flex:0 0 auto;min-width:180px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--ink);font-size:.9rem;box-shadow:0 1px 2px rgba(0,0,0,.03);}

  .info-toggle{
    width:40px;
    height:40px;
    border-radius:999px;
    border:1px solid #838796;
    background:#a8adbd;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:1.1rem;
    cursor:pointer;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
    transition:background .15s ease, box-shadow .15s ease, transform .08s ease, border-color .15s ease, color .15s ease;
  }
  .info-toggle span{
    position:relative;
    top:-1px;
    font-weight:600;
  }
  .info-toggle:hover{
    background:#f0f2ff;
    box-shadow:0 4px 10px rgba(0,0,0,.08);
    transform:translateY(-1px);
  }
  .info-toggle[aria-pressed="true"]{
    background:#405cf5;
    color:#fff;
    border-color:#405cf5;
  }

  .info-panel{
    max-width:920px;
    margin:0 auto 24px;
    padding:16px 18px 14px;
    border-radius:14px;
    background:rgba(255,255,255,.9);
    border:1px solid var(--border);
    box-shadow:0 10px 24px rgba(15,23,42,.04);
    font-size:.94rem;
    line-height:1.5;
    color:var(--muted);
    text-align:left;
    display:none;
  }
  .info-panel--visible{display:block;}
  .info-panel h2{
    font-size:1.02rem;
    margin:0 0 .4rem;
    font-weight:700;
    color:var(--ink);
  }
  .info-panel p{margin:.35rem 0;}

  .grid{display:grid;gap:var(--gap);align-items:start;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));max-width:100%}
  @media (min-width:1800px){.grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}}
  .fullbleed{width:100%;margin:0;padding-inline:clamp(16px,3vw,48px)}
  .card{position:relative;display:flex;flex-direction:column;gap:8px;text-decoration:none;color:inherit;border-radius:12px}
  .thumb{width:100%;aspect-ratio:3/4;object-fit:cover;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);background:#f0f2f7;border:1px solid var(--border)}
  .title{font-weight:700;font-size:.98rem;line-height:1.3}
  .card:focus-visible{outline:2px solid #405cf5;outline-offset:4px;border-radius:12px}
  .note-bubble{position:absolute;left:50%;top:-10px;transform:translate(calc(-50% + var(--shift,0px)),-100%);width:max-content;max-width:min(600px,90vw);white-space:normal;background:rgba(20,23,31,.96);color:#fff;font-size:.9rem;line-height:1.35;padding:10px 12px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:10;pointer-events:none;opacity:0;visibility:hidden;transition:opacity .15s ease,visibility .15s ease;text-align:left;text-wrap:pretty;hyphens:auto;word-break:break-word}
  .note-bubble::after{content:"";position:absolute;left:50%;top:100%;transform:translateX(-50%);border:8px solid transparent;border-top-color:rgba(20,23,31,.96)}
  .card:hover .note-bubble,.card:focus-within .note-bubble,.card.show-note .note-bubble{opacity:1;visibility:visible}
  @media (max-width:700px){
    .note-bubble{top:auto;bottom:-10px;transform:translate(calc(-50% + var(--shift,0px)),100%)}
    .note-bubble::after{top:auto;bottom:100%;border-top-color:transparent;border-bottom-color:rgba(20,23,31,.96)}
  }
  .empty{text-align:center;color:var(--muted);padding:40px 0 24px}
</style>

<VideoBg>
  <Header />
  <main class="wrap wrap--wide">
    <div class="intro" role="region" aria-label="Art header">
      <h1>ðŸŽ¨ Art</h1>
      <p class="hint">
        I look at one work of art daily using
        <a
          href="https://getdailyart.com"
          target="_blank"
          rel="noopener noreferrer"
          ><strong>DailyArt</strong></a
        >.
        {(art.length).toLocaleString('en-US')} pieces so far!
      </p>

      <div class="toolbar">
        <input
          id="q"
          type="search"
          placeholder="Search title or noteâ€¦"
          aria-label="Filter art"
        />
        <select id="movement-filter" aria-label="Filter by movement">
          <option value="">All movements</option>
        </select>
        <button
          type="button"
          id="info-toggle"
          class="info-toggle"
          aria-label="About my art viewing"
          aria-expanded="false"
          aria-pressed="false"
        >
          <span>?</span>
        </button>
      </div>

      <section id="art-info" class="info-panel" hidden>
        <h2>Why I Log Art</h2>
        <p>
          This page is my visual diary. Instead of scrolling feeds, I look at one work of art a day
          and write a short structured note about it.
        </p>

        <h2>DailyArt as a Ritual</h2>
        <p>
          Most of these pieces come from the <strong>DailyArt</strong> app. I treat each one like a
          tiny museum visit: pause, look, read, then log.
        </p>

        <h2>How to Read This Grid</h2>
        <p>Hover over a painting to see my note in this format:</p>
        <p>
          <strong>Date Â· Title Â· Artist Â· Year Â· Medium Â· Movement Â· Country Â· Source</strong>
        </p>
        <p>
          On mobile, tap once to reveal the note, then tap again to open the link
          (usually to DailyArt, a museum page, or a reference site).
        </p>

        <h2>Future Stats</h2>
        <p>
          Later Iâ€™ll surface patterns here: most visited artists, favorite periods, countries, and
          streaks powered by my Google Sheets logs.
        </p>
      </section>
    </div>

    {art.length === 0 ? (
      <div class="empty">No art found in this collection.</div>
    ) : (
      <div class="grid fullbleed" id="grid" role="list">
        {art.map((a) => (
          <a
            class="card"
            role="listitem"
            href={a.href}
            target="_blank"
            rel="noopener noreferrer"
            title={a.title}
            data-title={a.title.toLowerCase()}
            data-note={(a.note || '').toLowerCase()}
            data-note-raw={a.note || ''}
          >
            <img
              class="thumb"
              src={a.cover}
              alt={a.title}
              loading="lazy"
              decoding="async"
              sizes="(min-width: 1800px) 260px, (min-width: 900px) 20vw, 40vw"
            />
            <div class="title">{a.title}</div>
            {a.note ? (
              <div class="note-bubble" role="tooltip">
                {a.note}
              </div>
            ) : null}
          </a>
        ))}
      </div>
    )}
  </main>
  <Footer />
</VideoBg>

<script>
  (function(){
    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    const debounce = (fn,ms)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
    const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

    const grid = $('#grid');
    const input = $('#q');
    const movementSelect = $('#movement-filter');

    if (!grid || !input) return;

    const cards = $$('.card', grid);
    const haystack = new Map(
      cards.map(c => [c, norm((c.dataset.title||'') + ' ' + (c.dataset.note||''))])
    );

    // ðŸ”¹ Canonical movement list (ordered: primary, secondary, then Other)
    const CANONICAL_MOVEMENTS = [
      'Impressionism',
      'Post-Impressionism',
      'Expressionism',
      'Realism',
      'Cubism',
      'Symbolism',
      'Mannerism',
      'Neoclassicism',
      'Romanticism',
      'Ukiyo-e',
      'Dutch Golden Age',
      'Modernism',
      'Northern Renaissance',
      'Italian Renaissance',
      'Baroque',
      'Fauvism',
      'Contemporary',
      'Abstract Expressionism',
      'Surrealism',
      'Pointillism',
      'Art Nouveau',
      'Flemish Baroque',
      'Proto-Renaissance',
      'Minimalism',
      'Other',
    ];

    // ðŸ”¹ Alias map (extend if you notice variant labels)
    const MOVEMENT_ALIAS_MAP = {};
    MOVEMENT_ALIAS_MAP[norm('Ukiyo-e/Rinpa')] = 'Ukiyo-e / Rinpa';
    MOVEMENT_ALIAS_MAP[norm('Dutch Golden Age Painting')] = 'Dutch Golden Age';
    MOVEMENT_ALIAS_MAP[norm('Proto Renaissance')] = 'Proto-Renaissance';

    const movementsInUse = new Set();

    // ðŸ”¹ Extract movement from note and attach to each card
    // Note format: Date Â· Title Â· Artist Â· Country Â· Medium Â· Movement/Type Â· Year
    cards.forEach(c => {
      const raw = c.dataset.noteRaw || '';
      const parts = raw.split('Â·').map(s => s.trim());
      if (parts.length < 6) return;

      const rawMovement = parts[5];          // 6th field
      const rawNorm = norm(rawMovement);

      // Try exact canonical match
      let canonical = CANONICAL_MOVEMENTS.find(m => norm(m) === rawNorm);

      // Try alias map
      if (!canonical && MOVEMENT_ALIAS_MAP[rawNorm]) {
        canonical = MOVEMENT_ALIAS_MAP[rawNorm];
      }

      // If still unknown, group into "Other"
      if (!canonical) {
        canonical = 'Other';
      }

      const key = norm(canonical);
      c.dataset.movement = canonical;
      c.dataset.movementKey = key;
      movementsInUse.add(canonical);
    });

    // ðŸ”¹ Populate dropdown (only movements that actually appear)
    if (movementSelect) {
      const options = CANONICAL_MOVEMENTS.filter(m => movementsInUse.has(m));
      options.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        movementSelect.appendChild(opt);
      });
    }

    function filter(){
      const s = norm(input.value.trim());
      const selectedMovement = movementSelect ? movementSelect.value : '';
      const selectedKey = norm(selectedMovement);

      cards.forEach(c => {
        const textMatches = !s || s.split(/\s+/).every(w => haystack.get(c).includes(w));
        const movementMatches =
          !selectedMovement ||
          (c.dataset.movementKey && c.dataset.movementKey === selectedKey);

        c.style.display = (textMatches && movementMatches) ? '' : 'none';
      });
    }

    input.addEventListener('input', debounce(filter, 80));
    if (movementSelect) {
      movementSelect.addEventListener('change', filter);
    }

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        input.value = '';
        if (movementSelect) movementSelect.value = '';
        filter();
        input.focus();
      } else if (e.key === '/' && e.target === document.body) {
        e.preventDefault();
        input.focus();
      }
    });

    filter();

    // Tooltip positioning (same pattern as Books/Albums)
    function adjust(bubble){
      if (!bubble) return;
      bubble.style.setProperty('--shift', '0px');
      const r = bubble.getBoundingClientRect(), m = 8;
      let shift = 0;
      if (r.left < m) shift = m - r.left;
      else if (r.right > innerWidth - m) shift = (innerWidth - m) - r.right;
      if (shift) bubble.style.setProperty('--shift', `${shift}px`);
    }

    grid.addEventListener('mouseenter', e => {
      const b = e.target.closest('.card')?.querySelector('.note-bubble');
      if (!b) return;
      requestAnimationFrame(() => adjust(b));
    }, true);

    grid.addEventListener('focusin', e => {
      const b = e.target.closest('.card')?.querySelector('.note-bubble');
      if (!b) return;
      requestAnimationFrame(() => adjust(b));
    });

    addEventListener('resize', () => $$('.note-bubble').forEach(adjust));

    // Mobile tap-to-show tooltip
    document.addEventListener('click', e => {
      const card = e.target.closest('.card');
      if (!card){
        cards.forEach(c => c.classList.remove('show-note'));
        return;
      }
      if (!card.querySelector('.note-bubble')) return;
      if (card.classList.contains('show-note')) return;
      e.preventDefault();
      cards.forEach(c => c.classList.remove('show-note'));
      card.classList.add('show-note');
      requestAnimationFrame(() => adjust(card.querySelector('.note-bubble')));
      setTimeout(() => card.classList.remove('show-note'), 2500);
    }, true);

    // Info panel toggle
    const infoBtn = $('#info-toggle');
    const infoPanel = $('#art-info');
    if (infoBtn && infoPanel){
      infoBtn.addEventListener('click', ()=>{
        const isOpen = infoPanel.classList.toggle('info-panel--visible');
        infoPanel.hidden = !isOpen;
        infoBtn.setAttribute('aria-pressed', isOpen ? 'true' : 'false');
        infoBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        if (isOpen){
          infoPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    }
  })();
</script>
